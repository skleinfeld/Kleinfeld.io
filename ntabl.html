---
layout: default
title: NTABL
permalink: /ntabl/
---

<section class="relative overflow-hidden">
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-40 left-1/2 -translate-x-1/2 h-[520px] w-[1400px] rounded-full blur-3xl"
         style="background:radial-gradient(ellipse at center, rgba(10,132,255,.18), rgba(191,90,242,.12) 45%, transparent 65%)"></div>
  </div>

  <div class="mx-auto max-w-[1400px] px-4 sm:px-6 py-10">
    <!-- Page header -->
    <div class="flex items-center gap-4">
      <img src="{{ "NTABL - Gann's Bulls Logo.png" | relative_url | uri_escape }}" alt="Gann’s Bulls"
           class="h-12 w-12 rounded bg-white object-contain p-1">
      <div>
        <h1 class="text-2xl sm:text-3xl font-semibold leading-tight">NTABL</h1>
        <p class="text-d-sub text-[14px]">Personal and Team statistics</p>
      </div>
    </div>

    <!-- PERSONAL (Career) -->
    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3">Personal Career Stats</h2>

      <div class="rounded-2xl border border-d-line bg-d-card shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-[1200px] w-full text-[13px]">
            <thead id="p-head" class="bg-white/5 sticky top-24 z-10"></thead>
            <tbody id="p-body"></tbody>
            <tfoot id="p-foot"></tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- TEAM (Season filter) -->
    <div class="mt-12">
      <div class="flex items-end justify-between gap-4 mb-3">
        <h2 class="text-xl font-semibold">Team Stats</h2>
        <div class="flex items-center gap-2">
          <label for="season" class="text-[13px] text-d-sub">Season</label>
          <select id="season" class="bg-transparent border border-d-line rounded-full px-3 py-1.5 text-sm">
            <option value="summer2024">Summer 2024</option>
            <option value="summer2025">Summer 2025</option>
            <option value="fall2025">Fall 2025</option>
          </select>
        </div>
      </div>

      <div class="rounded-2xl border border-d-line bg-d-card shadow-card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-[1200px] w-full text-[13px]">
            <thead id="t-head" class="bg-white/5 sticky top-24 z-10"></thead>
            <tbody id="t-body"></tbody>
            <tfoot id="t-foot"></tfoot>
          </table>
        </div>
      </div>

      <p class="mt-3 text-d-sub text-[12px]">
        Derived metrics when columns exist: AVG = H/AB • OBP = (H+BB+HBP)/(AB+BB+HBP+SF) • SLG = TB/AB • OPS = OBP+SLG.
      </p>
    </div>
  </div>
</section>

<!-- Papa Parse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* =========================== SOURCE FILES =========================== */
/* Using your new filenames */
const personalCareerCSV = "{{ 'personal-batting-career.csv' | relative_url }}";

const teamFiles = {
  summer2024: "{{ 'team-batting-summer-2024.csv' | relative_url }}",
  summer2025: "{{ 'team-batting-summer-2025.csv' | relative_url }}",
  fall2025:   "{{ 'team-batting-fall-2025.csv'   | relative_url }}"
};

/* ========================== CSV HELPERS ============================ */
const $ = s => document.querySelector(s);

function fetchCSV(url){
  // Safe for spaces etc. (your files are already clean)
  const safe = encodeURI(url);
  return new Promise((resolve, reject) => {
    Papa.parse(safe, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: 'greedy',
      complete: r => resolve(r.data),
      error: err => reject(err)
    });
  });
}

const fmt3 = n => (isNaN(n) ? '—' : Number(n).toFixed(3).replace(/^0/,''));
const divz = (n,d) => d>0 ? n/d : 0;

/* Normalize common header variants into consistent keys */
function normalizeRows(rows){
  const normKey = k => String(k).trim().replace(/\u2013|\u2014/g,'-').replace(/\s+/g,' ').toLowerCase();
  const map = {
    'season':'Season','division':'Division','team':'Team',
    'last':'Last','first':'First',
    'gp':'GP','g':'GP','gs':'GS','pa':'PA','ab':'AB','r':'R','h':'H',
    '1b':'1B','2b':'2B','3b':'3B','hr':'HR','rbi':'RBI','tb':'TB',
    'bb':'BB','so':'SO','k-l':'K-L','k l':'K-L','hbp':'HBP','sf':'SF',
    'sb':'SB','sb-att':'SB-ATT','sb att':'SB-ATT','cs':'CS',
    'avg':'AVG','obp':'OBP','slg':'SLG','ops':'OPS'
  };
  return rows.map(row=>{
    const out = {};
    Object.entries(row).forEach(([k,v])=>{
      const key = map[normKey(k)] || k;
      out[key] = v;
    });
    return out;
  });
}

/* Add derived stats if inputs exist */
function addDerived(rows){
  if(!rows || !rows.length) return rows;
  const keys = Object.keys(rows[0]);
  const has = k => keys.includes(k);
  return rows.map(r=>{
    const H   = +r.H   || 0, AB = +r.AB || 0, BB = +r.BB || 0, HBP= +r.HBP||0, SF = +r.SF || 0;
    const _1B = +r['1B']||0, _2B = +r['2B']||0, _3B = +r['3B']||0, HR = +r.HR||0;
    const TB  = _1B + 2*_2B + 3*_3B + 4*HR;

    if(has('H')&&has('AB')) r.AVG = fmt3(divz(H,AB));
    if(has('AB')&&(has('BB')||has('HBP'))) r.OBP = fmt3(divz((H+BB+HBP),(AB+BB+HBP+SF)));
    if(has('AB')&&(has('1B')||has('2B')||has('3B')||has('HR'))) r.SLG = fmt3(divz(TB,AB));
    if(r.OBP && r.SLG && !isNaN(parseFloat(r.OBP)) && !isNaN(parseFloat(r.SLG))){
      r.OPS = fmt3(parseFloat(r.OBP)+parseFloat(r.SLG));
    }
    return r;
  });
}

/* Preferred column order (extras appended to end) */
const PREFERRED = [
  'Season','Division','Team','Last','First',
  'GP','PA','AB','R','H','1B','2B','3B','HR','RBI',
  'BB','HBP','SO','K-L',
  'SB','SB-ATT','CS',
  'TB','AVG','OBP','SLG','OPS'
];

function orderColumns(rows){
  if(!rows || !rows.length) return [];
  const seen = new Set();
  const cols = [];
  PREFERRED.forEach(c => { if(c in rows[0]) { cols.push(c); seen.add(c); }});
  Object.keys(rows[0]).forEach(c => { if(!seen.has(c)) cols.push(c); });
  return cols;
}

/* Build table */
function buildTable(rootIds, rows){
  const [headId, bodyId, footId] = rootIds;
  const thead = document.getElementById(headId);
  const tbody = document.getElementById(bodyId);
  const tfoot = document.getElementById(footId);

  if(!rows || !rows.length){
    thead.innerHTML = '<tr><th class="px-3 py-3 border-b border-d-line">No data</th></tr>';
    tbody.innerHTML = '';
    tfoot.innerHTML = '';
    return;
  }

  const cols = orderColumns(rows);

  thead.innerHTML =
    '<tr class="text-left">'+
    cols.map((c,i)=>`<th class="px-3 py-3 border-b border-d-line ${i===0?'sticky left-0 bg-white/5 backdrop-blur':''}">${c}</th>`).join('')+
    '</tr>';

  tbody.innerHTML = rows.map((r,i)=>{
    const stripe = i%2 ? 'bg-white/[.03] hover:bg-white/[.06]' : 'hover:bg-white/[.06]';
    return `<tr class="${stripe}">
      ${
        cols.map((c,ci)=>`<td class="px-3 py-2.5 border-t border-d-line ${ci===0?'sticky left-0 bg-d-card':''}">
          ${r[c] ?? ''}</td>`).join('')
      }
    </tr>`;
  }).join('');

  // Totals for numeric columns
  const numeric = new Set();
  rows.forEach(r => cols.forEach(c => { const v=r[c]; if(v!==''&&v!==null&&!isNaN(v)) numeric.add(c); }));
  if(numeric.size){
    const totals = {};
    numeric.forEach(c => totals[c] = rows.reduce((a,r)=>a+(+r[c]||0),0));
    tfoot.innerHTML = '<tr class="bg-white/5">'+
      cols.map((c,i)=> i===0
        ? `<th class="px-3 py-3 border-t border-d-line sticky left-0 bg-white/5 text-left">Totals</th>`
        : `<th class="px-3 py-3 border-t border-d-line text-left">${totals[c] ?? ''}</th>`
      ).join('') + '</tr>';
  } else {
    tfoot.innerHTML = '';
  }
}

/* ============================ LOADERS ============================== */
async function loadPersonal(){
  try{
    const raw  = await fetchCSV(personalCareerCSV);
    const norm = normalizeRows(raw);
    const withDerived = addDerived(norm);
    buildTable(['p-head','p-body','p-foot'], withDerived);
  }catch(e){
    console.error('Personal CSV load error', e);
    $('#p-head').innerHTML = '<tr><th class="px-3 py-3 border-b border-d-line">Error</th></tr>';
    $('#p-body').innerHTML = '<tr><td class="px-3 py-3">Unable to load CSV.</td></tr>';
    $('#p-foot').innerHTML = '';
  }
}

async function loadTeam(){
  const season = $('#season').value;
  const url = teamFiles[season];
  try{
    const raw  = await fetchCSV(url);
    const norm = normalizeRows(raw);
    const withDerived = addDerived(norm);
    buildTable(['t-head','t-body','t-foot'], withDerived);
  }catch(e){
    console.error('Team CSV load error', e);
    $('#t-head').innerHTML = '<tr><th class="px-3 py-3 border-b border-d-line">Error</th></tr>';
    $('#t-body').innerHTML = '<tr><td class="px-3 py-3">Unable to load CSV.</td></tr>';
    $('#t-foot').innerHTML = '';
  }
}

/* ============================ INIT ================================ */
document.getElementById('season').addEventListener('change', loadTeam);
loadPersonal();
loadTeam();
</script>